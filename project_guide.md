## 📋 [개원포화도 프로젝트] Project Guide

### 1. 프로젝트 개요

* **목적:** 행정구역별(시군구/행정동) 인구 데이터와 병의원 현황 데이터를 결합하여 전공과목별 '개원 포화도 지수'를 산출하고 시각화함.
* **대상 유저:** 개원 입지를 고민하는 의사(개비공 커뮤니티 회원).
* **주요 기술 스택:** Python, Streamlit (UI), Pandas (데이터 분석), Plotly/Mapbox (지도 시각화).

---

### 2. 데이터 수집 전략 (Data Acquisition)

프로젝트에 필요한 API 연동 및 데이터 수집을 위해 `GUIDE` 폴더의 문서를 적극 참조합니다.
* **공공데이터포털 API 인증키:** `GUIDE/공공데이터포탈 API키.txt` 참조 (개인 인증키 활용).

#### A. 인구 데이터 (이중 API 구조)

| API | URL | 제공 데이터 |
|-----|-----|------------|
| RDOA (행안부) | `rdoa.jumin.go.kr/openStats` | 총인구수, 세대수, 성별 인구 |
| JUMIN (행안부) | `jumin.mois.go.kr` | 연령대별 인구 (10세 단위) |

* **관련 가이드:** `GUIDE/행정안전부_행정동별(통반단위) 주민등록 인구 및 세대현황 가이드.docx`
* **⚠️ JUMIN 서버 주의사항:** 연속 요청 시 `RemoteDisconnected` 발생. **최대 3회 재시도 + 지수 백오프(1→2→4초) + 세션 재생성** 로직으로 대응. sido 레벨 루프에서는 구(區) 간 0.8초 딜레이 추가 필요.

#### B. 병의원 데이터 (심평원 HIRA Open API)

* **데이터 소스:** `apis.data.go.kr/B551182/hospInfoServicev2/getHospBasisList`
* **가이드 문서:** `GUIDE/OpenAPI활용가이드_건강보험심사평가원(의료기관별상세정보서비스).docx`
* **⚠️ clCd 파라미터 주의:** HIRA API는 `clCd`에 **단일값만 지원**. 콤마 구분 다중값(`"31,21,11"`) 전달 시 0건 반환됨. 단일 값이면 전달, 복수면 파라미터 생략하여 전체 종별 반환.
* **⚠️ API 오류 감지:** HTTP 200이어도 XML 내부에 `resultCode`가 있을 수 있음. `_parse_response`에서 `resultCode != "00"` 체크로 오류 감지.

---

### 3. 데이터 처리 및 지수 산출 로직

#### A. 포화도 지수 ($SI$, Saturation Index) 정의

단순 인구 대비 병원 수가 아닌, **타겟 인구 가중치**를 적용한 지수를 산출합니다.

1.  **일반 포화도:** $SI_{general} = \frac{\text{해당 구역 총 인구수}}{\text{해당 구역 특정과 의원 수}}$
2.  **세대 포화도:** $SI_{household} = \frac{\text{해당 구역 총 세대수}}{\text{해당 구역 특정과 의원 수}}$
3.  **타겟 인구 포화도:** $SI_{target} = \frac{\text{해당 구역 타겟 연령층 인구수}}{\text{해당 구역 특정과 전문의 총 인원수}}$

*   **블루오션 가중치**: 의원이 0개인 지역은 $SI = \infty$로 처리(코드상 3.0)되어 지도에서 가장 진한 초록색('기회 최대')으로 표시됩니다.

#### B. match_key 생성 규칙

병원 데이터(`adm_cd2`, GeoJSON 기반)와 인구 데이터(`admmCd`) 간의 키 통일 방식:

| 분석 레벨 | match_key 형식 | 예시 |
|-----------|----------------|------|
| national | 시도코드 앞 2자리 | `"11"` (서울) |
| sido | 시도코드+시군구코드 5자리 | `"11110"` (종로구) |
| dong | 전체 행정동코드 10자리 | `"1111051500"` |

특수 코드 변환: `adm_cd2`가 "42"로 시작 → "51"(강원), "45"로 시작 → "52"(전북), "41000..."으로 시작 → "36"(세종)

---

### 4. 개발 단계별 진행 현황

- [x] **1단계 ~ 5단계 (완료):** 기초 인프라 및 MVP 구축
  - API 인증키 관리 설정, 인구/병원 API 모듈화, 데이터 병합 및 Streamlit UI 기본 구성 완료.

- [x] **6단계 ~ 9단계 (완료):** 버그 수정 및 전국 확장 기반 마련
  - 포화도 등급 반전(높은 SI=초록), 지도 클릭 이벤트 연동, 전국 GeoJSON 도입 및 HIRA API Fallback 로직 강화.
  - **심평원 독자 코드 체계 발견**: 행안부 표준 코드와 다른 심평원만의 시도/시군구 코드를 전수 조사하여 매핑 테이블 구축.

- [x] **10단계 (완료):** 계층적 거시 분석 체계 도입 (전국 및 시도 전체)
  - **National/Sido 레벨**: 17개 시도별 비교 및 특정 시도 내 구별 비교 기능 추가.
  - **동적 GeoJSON Dissolve**: 행정동 경계를 실시간으로 병합하여 시도/구 단위의 깔끔한 지도 시각화 구현.

- [x] **11단계 (완료):** UI/UX 감성 품질 고도화
  - **로딩 UI 혁신**: 구글 드라이브 이미지 + CSS 스피너 애니메이션 + 안내 문구.
  - **폰트 및 아이콘 보정**: Material Symbols 텍스트 겹침 버그를 CSS Ligature 설정으로 완전 해결.
  - **지도 제어 강화**: 확대/축소 버튼 및 휠 줌 활성화.

- [x] **12단계 (완료):** 데이터 정밀도 및 타입 안정성 확보
  - **동 단위 전수 합산**: API의 불안정한 상위 집계 대신 하위 데이터를 모두 모아 합산하는 방식으로 정확도 100% 달성.
  - **숫자 타입 강제**: Pandas의 Object 타입 인식 오류를 `int64` 캐스팅 및 `pd.to_numeric`으로 원천 차단.

- [x] **13단계 (완료):** 운영 보안 (관리자 모드)
  - **전국 분석 보호**: 고비용 API 호출인 전국 단위 분석 시 관리자 비밀번호(`ADMIN_PASSWORD`) 요구 로직 추가.

- [x] **14단계 (완료):** 행정구역 코드 표준화 및 최종 안정화
  - **강원/전북/세종 특수 처리**: 신설된 특별자치도 코드(51, 52, 36)와 구코드(42, 45, 41) 간의 정합성을 `_get_match_key` 및 `_standardize_code`로 완벽히 해결.
  - **동적 컬럼 파싱**: API 레벨별로 달라지는 테이블 구조를 역방향 인덱싱으로 극복하여 데이터 누락 방지.

- [x] **15단계 (완료):** 중요 버그 수정 및 데이터 정확성 복구
  - **[버그] DataFrame apply 오류**: geopandas sjoin 이후 `hosp_mapped`에 중복 컬럼 발생 시 `apply(func, axis=1)`이 Series 대신 DataFrame을 반환하는 pandas 버그. `loc[:, ~columns.duplicated()]`로 사전 제거하여 해결.
  - **[버그] specialty_cd 컬럼 누락**: `h_frames`가 빈 경우 `pd.DataFrame()`(컬럼 없음)으로 폴백되어 이후 groupby에서 `KeyError`. `HOSPITAL_COLUMNS` 상수를 `hospital_api.py`에 정의하고 빈 폴백 시 `pd.DataFrame(columns=HOSPITAL_COLUMNS)` 사용으로 해결.
  - **[버그] HIRA API clCd 다중값 미지원**: `clCd=31,21,11` 전달 시 0건 반환. 단일값일 때만 파라미터 전달, 복수 시 생략하도록 수정. 동시에 `_parse_response`에 `resultCode` 체크로 API 오류 가시화.
  - **[버그] dgsbjtCd 코드 오기입**: `"18": 재활의학과`, `"22": 가정의학과`, `"24": 신경과`가 전부 잘못된 HIRA 코드. 실제 API 기준으로 전면 교정 (`재활의학과→21`, `가정의학과→23`, `신경과→02`).
  - **[버그] JUMIN 서버 연결 끊김**: sido 레벨(서울 전체 등) 분석 시 25개 구 × 2회 = 50+ 연속 POST 요청으로 `RemoteDisconnected` 발생. `_reset_jumin_session()` + 지수 백오프 재시도 + 구 간 딜레이 0.8초 추가로 해결.

- [x] **16단계 (완료):** UI 대폭 개선
  - **지도 스크롤 줌**: `config={"scrollZoom": True}` + `uirevision="map-view"`로 줌 후 지도 위치 유지.
  - **포화도 막대그래프 추가**: 지도 우측(40%)에 행정동별 포화도 순위 막대그래프 추가. 기회 최대(∞) 지역은 맨 위 별도 표시.
  - **지도 클릭 → 의원 목록**: `on_select="rerun"` + `clickmode="event+select"` 조합으로 지역 클릭 시 해당 행정동의 의원 상세 목록(의원명, 종별, 주소, 전문의수, 의사수) 표시. 등급 배지 + 닫기 버튼 포함.
  - **요약 지표 카드**: 과목별 총 의원 수 / 분석 행정동 수 / 평균 포화도 / 기회 지역 수 표시.
  - **로딩 스피너**: CSS `@keyframes` 애니메이션 링 스피너 + 이미지 + 안내 문구.
  - **디버그 패널**: 기본 접힘(expanded=False)으로 변경.

- [x] **17단계 (완료):** 진료과목 코드 전면 확장
  - **HIRA API 공식 코드표 기준** (`GUIDE/OpenAPI활용가이드...docx` 참조) 10개 → 34개로 확장.
  - 의과 20종 / 치과 6종(치과, 교정과, 소아치과, 치주과, 보존과, 통합치의학과) / 한방 8종(한방내과, 침구과, 한방재활의학과, 사상체질과 등) 추가.

- [x] **18단계 (완료):** UI/UX 세부 개선 및 병원 상세 팝업 도입
  - **호버 툴팁 강화**: 지도 위 커서 호버 시 기존 포화도·의원수에 더해 총 인구수·세대수 추가 표시.
  - **클릭 요약 지표 확장**: 행정동 클릭 시 하단 요약 카드를 3개 → 5개(의원수·전문의수·포화도·총인구수·세대수)로 확장.
  - **병원 상세 팝업 (`@st.dialog`)**: 의원 목록에서 [상세] 버튼 클릭 시 모달 팝업 표시.
    - 표시 항목: 의료기관명, 종별, 주소, **진료과목 전체** (같은 `ykiho`의 모든 `specialty_nm`을 배지로 표시), 의사 총수, 전문의 수, 개설일자(`estbDd`).
    - 개설일자 포맷: `"20050312"` → `"2005-03-12"` 자동 변환.
    - 네이버 지도 바로가기 버튼 (검색 쿼리: 병원명 + 시도명 + 동명 — 전체 주소는 검색 실패 발생).
  - **`hospital_api.py` 컬럼 확장**: `HOSPITAL_COLUMNS` 및 `_KEEP` 리스트에 `"estbDd"` 추가. 캐시 초기화 후 재분석 시 개설일자 표시.
  - **한방 과목 제거**: 진료과목 선택란에서 한방 8종(한방내과·한방부인과·한방소아과·한방안이비인후피부과·한방신경정신과·침구과·한방재활의학과·사상체질과) 제거. 현재 선택 가능 과목: 의과 20종 + 치과 6종.
  - **초록 버튼 테마**: 분석 실행·캐시 초기화 등 primary 버튼, 네이버 지도 link 버튼, multiselect 선택 태그를 `#16A34A` 초록 계열로 통일. `* {}` 자식 선택자로 내부 `<p>` 색상 덮어쓰기 문제 해결.
  - **지도·막대그래프 색상 통일**: 기존 지도의 연속 컬러스케일(빨강→주황→연두→초록)을 `saturation_level` 기반 이산 4색으로 교체. 포화=`#DC2626`, 보통=`#D97706`, 여유=`#16A34A`, 데이터없음=`#9CA3AF`. 지도 colorbar에 등급명 레이블 표시.
  - **막대그래프 평균 기준선**: x=1 위치에 점선 세로선 + "평균(1.0)" 레이블 추가. 기준선 좌측=포화, 우측=여유를 직관적으로 파악 가능.

---

### 5. 현재 파일 구조

```
개원포화도/
├── .env                         # API 인증키 및 ADMIN_PASSWORD
├── config.py                    # 환경변수 로드 및 전역 설정
├── app.py                       # Streamlit 메인 대시보드 (UI/지도/로직 통합)
├── modules/
│   ├── population_api.py        # 인구 데이터 수집 (전국/시도/동 단위, 재시도 로직 포함)
│   ├── hospital_api.py          # 병의원 데이터 수집 (심평원 실시간 연동, 34개 과목)
│   └── data_merge.py            # 데이터 병합, 코드 표준화 및 지수 산출
├── data/
│   └── geojson/
│       ├── national_dong.geojson  # 전국 행정동 경계 (원본)
│       └── seoul_dong.geojson     # 서울 전용 (백업용)
└── GUIDE/                       # API 가이드 문서 및 인증키 정보
```

---

### 6. 핵심 알고리즘: 계층적 코드 매핑 (Standardization)

분석의 정확도는 아래 3가지 코드 체계의 일치 여부에 달려 있습니다.
1. **인구 API**: 신표준 코드 (강원 51, 전북 52, 세종 36)
2. **HIRA API**: 심평원 독자 코드 (대구 23, 인천 22 등)
3. **GeoJSON**: 지도 경계 코드 (구코드 기반 42, 45, 41 등)

**[해결책]**: 모든 데이터는 수집 즉시 **인구 API 표준 코드**를 기준으로 `match_key`를 생성하도록 `_finalize_key` 함수가 실시간 번역을 수행함.

---

### 7. 진료과목 코드표 (HIRA API `dgsbjtCd` 기준)

> 출처: `GUIDE/OpenAPI활용가이드_건강보험심사평가원(의료기관별상세정보서비스).docx`

#### 의과
| 코드 | 과목명 | 코드 | 과목명 | 코드 | 과목명 |
|------|--------|------|--------|------|--------|
| 01 | 내과 | 02 | 신경과 | 03 | 정신건강의학과 |
| 04 | 외과 | 05 | 정형외과 | 06 | 신경외과 |
| 07 | 흉부외과 | 08 | 성형외과 | 09 | 마취통증의학과 |
| 10 | 산부인과 | 11 | 소아청소년과 | 12 | 안과 |
| 13 | 이비인후과 | 14 | 피부과 | 15 | 비뇨의학과 |
| 16 | 영상의학과 | 17 | 방사선종양학과 | 18 | 병리과 |
| 19 | 진단검사의학과 | 20 | 결핵과 | 21 | 재활의학과 |
| 22 | 핵의학과 | 23 | 가정의학과 | 24 | 응급의학과 |
| 25 | 직업환경의학과 | 26 | 예방의학과 | | |

#### 치과
| 코드 | 과목명 | 코드 | 과목명 | 코드 | 과목명 |
|------|--------|------|--------|------|--------|
| 49 | 치과 | 52 | 치과교정과 | 53 | 소아치과 |
| 54 | 치주과 | 55 | 치과보존과 | 61 | 통합치의학과 |

#### 한방
| 코드 | 과목명 | 코드 | 과목명 | 코드 | 과목명 |
|------|--------|------|--------|------|--------|
| 80 | 한방내과 | 81 | 한방부인과 | 82 | 한방소아과 |
| 83 | 한방안이비인후피부과 | 84 | 한방신경정신과 | 85 | 침구과 |
| 86 | 한방재활의학과 | 87 | 사상체질과 | | |

> ⚠️ **구 코드표와 혼동 금지**: `"18"=병리과`, `"21"=재활의학과`, `"22"=핵의학과`, `"23"=가정의학과`, `"24"=응급의학과`. 과거 코드에 오기입 있었음 (18→재활의학과로 잘못 매핑하던 버그 수정 완료).

---

### 8. 알려진 이슈 및 트러블슈팅

| 증상 | 원인 | 해결책 |
|------|------|--------|
| `Cannot set a DataFrame with multiple columns to the single column match_key` | geopandas sjoin 후 중복 컬럼 발생 | `loc[:, ~columns.duplicated()]`로 apply 전 중복 제거 |
| `KeyError: 'specialty_cd'` | h_frames 빈 경우 컬럼 없는 빈 DataFrame 생성 | `pd.DataFrame(columns=HOSPITAL_COLUMNS)` 폴백 |
| 의원수/전문의수 0개 | `clCd=31,21,11` 다중값 → HIRA API 0건 반환 | 단일값만 전달, 복수 시 파라미터 생략 |
| `RemoteDisconnected` | sido 레벨 연속 POST 50+ 건 → JUMIN 서버 강제 종료 | 3회 재시도 + 세션 재생성 + 구 간 0.8초 딜레이 |
| 병의원 API 오류 무시 | HTTP 200이어도 XML 내 오류코드 존재 | `_parse_response`에서 `resultCode != "00"` 감지 후 예외 발생 |
| 네이버 지도 검색 실패 | 전체 주소(번지수 포함) 사용 시 검색 불일치 | 검색 쿼리를 `병원명 + 시도명 + 동명`으로 축소 |
| 버튼 글자색 미적용 | Streamlit이 버튼 내부 `<p>` 태그에 별도 색상 지정 | CSS 선택자에 `*` 자식 선택자 추가로 모든 하위 요소 강제 적용 |
| 지도·막대 색상 불일치 | 지도는 SI 연속값 기반, 막대는 등급 기반 색상 사용 | 지도를 `saturation_level` 기반 이산 4색으로 교체하여 동일 색 체계 통일 |

---

### 9. 향후 과제

| 과제 | 중요도 | 비고 |
|------|--------|------|
| 파일 기반 영구 캐시 도입 | 높음 | API 일일 할당량 보호 및 응답 속도 향상 |
| GeoJSON 최신화 (2025년형) | 중간 | 신규 행정동(개포3동 등) 누락분 반영 |
| 진료과목별 가중치 세분화 | 낮음 | 특정 과목별 전문의 vs 일반의 가중치 차등 적용 |
| sido 레벨 인구 API 병렬 요청 | 중간 | 현재 순차 수집(25개 구 × 0.8초) → asyncio 전환 시 속도 대폭 향상 가능 |

---
